x-agents-base: &agents-base
  build:
    context: .
    dockerfile: Dockerfile.agents
  image: transcendence/agents:latest
  restart: unless-stopped
  user: "1001:1001"
  env_file:
    - ../.env
  environment:
    DB_HOST: db
    DB_PORT: 5432
    DB_NAME: ${DB_NAME:-api42}
    DB_USER: ${DB_USER:-api42}
    DB_PASSWORD: ${DB_PASSWORD:-api42}
    CAMPUS_ID: ${CAMPUS_ID:-21}
    ROOT_DIR: /app
  volumes:
    - .:/app
    - ./.backlog:/app/.backlog
    - ./logs:/app/logs
    - ./exports:/app/exports
    - ./.cache:/app/.cache
  networks:
    - transcendence

services:

  # PostgreSQL: data storage
  db:
    image: postgres:16-alpine
    container_name: transcendence_db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-api42}"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      POSTGRES_USER: ${DB_USER:-api42}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-api42}
      POSTGRES_DB: ${DB_NAME:-api42}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./data/schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    networks:
      - transcendence

  # Nginx: serve static files + proxy to Node.js API
  web:
    image: nginx:alpine
    container_name: transcendence_web
    restart: unless-stopped
    depends_on:
      - db
      - api
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./godot:/usr/share/nginx/html/godot:ro
      - ./index.html:/usr/share/nginx/html/index.html:ro
      - ./assets:/usr/share/nginx/html/assets:ro
      - ./exports:/usr/share/nginx/html/api:ro
    ports:
      - "${WEB_PORT:-8000}:80"
    networks:
      - transcendence

  # Node.js API: WebSocket + real-time updates
  api:
    image: node:20-alpine
    container_name: transcendence_api
    restart: unless-stopped
    depends_on:
      - db
    working_dir: /app
    volumes:
      - ./api:/app/api
      - ./globe.html:/app/globe.html:ro
      - ./logs:/app/logs
      - ./exports:/app/exports
      - ./.backlog:/app/.backlog
    environment:
      NODE_ENV: production
      PORT: 3000
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-api42}
      DB_USER: ${DB_USER:-api42}
      DB_PASSWORD: ${DB_PASSWORD:-api42}
    command: sh -c "cd api && npm install && cd .. && node api/server.js"
    networks:
      - transcendence

  # Detector: polls API for updated users and enqueues IDs
  detector:
    <<: *agents-base
    container_name: transcendence_detector
    depends_on:
      - db
    environment:
      DETECTOR_INTERVAL: 60
    command: >
      bash -c "
        cd /app;
        while true; do
          start=$$(date +%s);
          scripts/agents/detector.sh;
          end=$$(date +%s);
          interval=$${DETECTOR_INTERVAL:-60};
          elapsed=$$((end - start));
          sleep_for=$$((interval - (elapsed % interval)));
          if [ $$sleep_for -gt 0 ]; then sleep $$sleep_for; fi
        done"

  # Fetcher (internal queue)
  fetcher:
    <<: *agents-base
    container_name: transcendence_fetcher
    depends_on:
      - db
    command: bash -c "cd /app && scripts/agents/fetcher.sh"

  # External fetcher (same script, different queue)
  fetcher-external:
    <<: *agents-base
    container_name: transcendence_fetcher_external
    depends_on:
      - db
    environment:
      FETCH_QUEUE_FILE: /app/.backlog/fetch_queue_external.txt
    command: bash -c "cd /app && scripts/agents/fetcher.sh"

  # Upserter: reads process_queue and writes into DB
  upserter:
    <<: *agents-base
    container_name: transcendence_upserter
    depends_on:
      - db
    command: bash -c "cd /app && scripts/agents/upserter.sh"

  # Backlog worker: enriches backlog users (achievements/projects/coalitions)
  backlog-worker:
    <<: *agents-base
    container_name: transcendence_backlog_worker
    depends_on:
      - db
    command: bash -c "cd /app && scripts/agents/backlog_worker_wrapper.sh"


  # Ops agent: token refresh, log cleanup, optional backups
  ops:
    <<: *agents-base
    container_name: transcendence_ops
    depends_on:
      - db
    environment:
      OPS_INTERVAL: 3600
    command: bash -c "cd /app && scripts/agents/ops_agent.sh"

networks:
  transcendence:
    driver: bridge
